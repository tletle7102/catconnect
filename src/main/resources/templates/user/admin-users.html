<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 사용자 목록</title>
</head>
<section layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title">사용자 목록</h1>
            <!-- 삭제 폼, REST API 호출로 사용자 삭제 -->
            <form id="delete-form" onsubmit="handleDelete(event)">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>번호</th>
                            <th>사용자 이름</th>
                            <th>이메일</th>
                            <th>역할</th>
                            <th>생성 시간</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
                <!-- 페이지네이션 UI -->
                <nav aria-label="사용자 페이지 네비게이션">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
                <button type="submit" class="btn btn-secondary mb-3">선택 삭제</button>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        console.log("admin-users.html: 스크립트 로드 시작");

        // 현재 페이지 상태
        let currentPage = 0;
        const pageSize = 10;

        document.addEventListener('DOMContentLoaded', function () {
            console.log("admin-users.html: DOM 로드 완료");
            // URL에서 page 파라미터 추출
            const urlParams = new URLSearchParams(window.location.search);
            currentPage = parseInt(urlParams.get('page')) || 0;
            loadUsers(currentPage);

            // 메시지 및 에러 표시는 ui-feedback.js의 checkUrlMessages()에서 자동 처리됨

            // 전체 선택 체크박스
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="ids"]');
                checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            });
        });

        // 사용자 목록 조회
        function loadUsers(page) {
            console.log("admin-users.html: 사용자 목록 조회, page=" + page);
            axios.get('/api/users', {
                params: { page: page, size: pageSize },
                withCredentials: true
            })
                .then(response => {
                    console.log("admin-users.html: 사용자 목록 조회 성공", response.data);
                    const pageData = response.data.data;
                    renderUsers(pageData.content);
                    renderPagination(pageData);
                })
                .catch(error => {
                    console.error("admin-users.html: 사용자 목록 조회 실패", error);
                    UI.handleApiError(error, "사용자 목록 조회 중 오류가 발생했습니다.");
                });
        }

        // 사용자 목록 렌더링
        function renderUsers(users) {
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = '';
            users.forEach((user, index) => {
                // 순번 계산: (현재 페이지 * 페이지 크기) + 인덱스 + 1
                const rowNumber = (currentPage * pageSize) + index + 1;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="vertical-align: middle;"><input type="checkbox" name="ids" value="${user.id}"></td>
                    <td style="vertical-align: middle;">${rowNumber}</td>
                    <td style="vertical-align: middle;">${user.username}</td>
                    <td style="vertical-align: middle;">${user.email}</td>
                    <td style="vertical-align: middle;">${user.role === 'USER' ? '일반 사용자' : '관리자'}</td>
                    <td style="vertical-align: middle;">${new Date(user.createdDttm).toLocaleString('ko-KR')}</td>
                    <td style="vertical-align: middle;">
                        <a href="#" class="btn btn-outline-secondary btn-sm" style="padding: 2px 8px; line-height: 1;" onclick="deleteUser(${user.id}, event)">X</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 페이지네이션 렌더링
        function renderPagination(pageData) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = pageData.totalPages;
            const currentPageNum = pageData.number;

            // 이전 버튼
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item' + (pageData.first ? ' disabled' : '');
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPageNum - 1}); return false;">이전</a>`;
            pagination.appendChild(prevLi);

            // 페이지 번호 (최대 5개 표시)
            let startPage = Math.max(0, currentPageNum - 2);
            let endPage = Math.min(totalPages - 1, startPage + 4);
            if (endPage - startPage < 4) {
                startPage = Math.max(0, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPageNum ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i + 1}</a>`;
                pagination.appendChild(li);
            }

            // 다음 버튼
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item' + (pageData.last ? ' disabled' : '');
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPageNum + 1}); return false;">다음</a>`;
            pagination.appendChild(nextLi);
        }

        // 페이지 이동
        function goToPage(page) {
            if (page < 0) return;
            currentPage = page;
            loadUsers(page);
            // URL 업데이트 (히스토리에 추가)
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            window.history.pushState({}, '', url);
        }

        // 다중 사용자 삭제 처리
        async function handleDelete(event) {
            event.preventDefault();
            console.log("admin-users.html: 삭제 요청 시작");
            // 선택된 체크박스 ID 수집
            const checkboxes = document.querySelectorAll('input[name="ids"]:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            if (ids.length === 0) {
                console.warn("admin-users.html: 삭제할 사용자 선택 안됨");
                UI.warning("삭제할 사용자를 선택하세요.");
                return;
            }
            // 삭제 확인
            const confirmed = await UI.confirmDelete(`선택한 ${ids.length}명의 사용자를 삭제하시겠습니까?`);
            if (!confirmed) {
                return;
            }
            // 삭제 API 호출
            const loading = UI.loading('사용자 삭제 중...');
            axios.delete('/api/users', { data: { ids }, withCredentials: true })
                .then(response => {
                    console.log("admin-users.html: 삭제 성공", response.data);
                    loading.hide();
                    UI.success('선택한 사용자가 삭제되었습니다.');
                    loadUsers(currentPage);
                })
                .catch(error => {
                    console.error("admin-users.html: 삭제 실패", error);
                    loading.hide();
                    UI.handleApiError(error, "사용자 삭제 중 오류가 발생했습니다.");
                });
        }

        // 개별 사용자 삭제 처리
        async function deleteUser(id, event) {
            event.preventDefault();
            console.log("admin-users.html: 개별 삭제 요청 시작, id=" + id);
            // 삭제 확인
            const confirmed = await UI.confirmDelete('이 사용자를 삭제하시겠습니까?');
            if (!confirmed) {
                return;
            }
            // 개별 삭제 API 호출
            axios.delete('/api/users/' + id, { withCredentials: true })
                .then(response => {
                    console.log("admin-users.html: 개별 삭제 성공", response.data);
                    UI.success('사용자가 삭제되었습니다.');
                    loadUsers(currentPage);
                })
                .catch(error => {
                    console.error("admin-users.html: 개별 삭제 실패", error);
                    UI.handleApiError(error, "사용자 삭제 중 오류가 발생했습니다.");
                });
        }
    </script>
</section>
</html>