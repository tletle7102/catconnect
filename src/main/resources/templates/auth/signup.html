<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title layout:title>회원가입</title>
    <style>
        .signup-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .signup-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }
        .signup-form .form-control {
            height: 48px;
            border-radius: 4px;
        }
        .signup-form .form-label {
            font-weight: 500;
            margin-bottom: 8px;
        }
        .signup-form .mb-3 {
            margin-bottom: 20px !important;
        }
        .btn-signup {
            width: 100%;
            height: 48px;
            font-size: 16px;
            font-weight: 500;
        }
        .login-link {
            text-align: center;
            margin-top: 20px;
        }
        .login-link a {
            color: #03c75a;
            text-decoration: none;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        .form-text {
            font-size: 12px;
            color: #888;
        }
        .password-requirements {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .email-input-group {
            display: flex;
            gap: 10px;
        }
        .email-input-group .form-control {
            flex: 1;
        }
        .email-input-group .btn {
            white-space: nowrap;
            height: 48px;
        }
        .verification-section {
            display: none;
            margin-top: 10px;
        }
        .verification-section.show {
            display: block;
        }
        .code-input-group {
            display: flex;
            gap: 10px;
        }
        .code-input-group .form-control {
            flex: 1;
            letter-spacing: 4px;
            text-align: center;
            font-size: 18px;
        }
        .code-input-group .btn {
            white-space: nowrap;
            height: 48px;
        }
        .verified-badge {
            display: none;
            color: #03c75a;
            font-size: 14px;
            margin-top: 5px;
        }
        .verified-badge.show {
            display: block;
        }
        .btn-signup:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }
        .phone-input-group {
            display: flex;
            gap: 10px;
        }
        .phone-input-group .form-control {
            flex: 1;
        }
        .phone-input-group .btn {
            white-space: nowrap;
            height: 48px;
        }
        .phone-verification-section {
            display: none;
            margin-top: 10px;
        }
        .phone-verification-section.show {
            display: block;
        }
        .phone-code-input-group {
            display: flex;
            gap: 10px;
        }
        .phone-code-input-group .form-control {
            flex: 1;
            letter-spacing: 4px;
            text-align: center;
            font-size: 18px;
        }
        .phone-code-input-group .btn {
            white-space: nowrap;
            height: 48px;
        }
        .phone-verified-badge {
            display: none;
            color: #03c75a;
            font-size: 14px;
            margin-top: 5px;
        }
        .phone-verified-badge.show {
            display: block;
        }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="signup-container">
        <h1 class="signup-title">회원가입</h1>
        <form id="signup-form" class="signup-form" onsubmit="handleSignup(event)">
            <div class="mb-3">
                <label for="username" class="form-label">아이디</label>
                <input type="text" id="username" name="username" class="form-control"
                       placeholder="영문, 숫자, 언더스코어 4~20자" required>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <div class="email-input-group">
                    <input type="email" id="email" name="email" class="form-control"
                           placeholder="example@gmail.com" required>
                    <button type="button" class="btn btn-outline-primary" id="sendCodeBtn" onclick="sendVerificationCode()">인증번호 발송</button>
                </div>
                <div class="verified-badge" id="verifiedBadge">이메일 인증 완료</div>
            </div>
            <div class="verification-section" id="verificationSection">
                <label for="verificationCode" class="form-label">인증번호</label>
                <div class="code-input-group">
                    <input type="text" id="verificationCode" name="verificationCode" class="form-control"
                           maxlength="6" placeholder="000000">
                    <button type="button" class="btn btn-outline-success" onclick="verifyCode()">확인</button>
                </div>
                <div class="form-text">이메일로 발송된 6자리 인증번호를 입력해주세요. (10분간 유효)</div>
            </div>
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">휴대폰 번호</label>
                <div class="phone-input-group">
                    <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control"
                           placeholder="01012345678" required>
                    <button type="button" class="btn btn-outline-primary" id="sendPhoneCodeBtn" onclick="sendPhoneVerificationCode()">인증번호 발송</button>
                </div>
                <div class="phone-verified-badge" id="phoneVerifiedBadge">휴대폰 인증 완료</div>
            </div>
            <div class="phone-verification-section" id="phoneVerificationSection">
                <label for="phoneVerificationCode" class="form-label">인증번호</label>
                <div class="phone-code-input-group">
                    <input type="text" id="phoneVerificationCode" name="phoneVerificationCode" class="form-control"
                           maxlength="6" placeholder="000000">
                    <button type="button" class="btn btn-outline-success" onclick="verifyPhoneCode()">확인</button>
                </div>
                <div class="form-text">휴대폰으로 발송된 6자리 인증번호를 입력해주세요. (3분간 유효)</div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" id="password" name="password" class="form-control"
                       placeholder="8~20자" required>
                <div class="password-requirements">영문, 숫자를 포함한 8~20자</div>
            </div>
            <div class="mb-3">
                <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
                <input type="password" id="passwordConfirm" name="passwordConfirm" class="form-control"
                       placeholder="비밀번호를 다시 입력" required>
            </div>
            <button type="submit" class="btn btn-success btn-signup" id="signupBtn" disabled>가입하기</button>
        </form>
        <div class="login-link">
            이미 계정이 있으신가요? <a href="/login">로그인</a>
        </div>
    </div>

    <script>
        var emailVerified = false;
        var verifiedEmail = '';
        var phoneVerified = false;
        var verifiedPhone = '';

        function sendVerificationCode() {
            var email = document.getElementById('email').value.trim();

            if (!email) {
                UI.warning('이메일을 입력해주세요.');
                return;
            }

            // 이메일 형식 검증
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                UI.warning('올바른 이메일 형식이 아닙니다.');
                return;
            }

            var loading = UI.loading('인증번호 발송 중...');

            fetch('/api/auth/signup/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '인증번호 발송에 실패했습니다.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    loading.hide();
                    UI.success(data.message);
                    // 인증번호 입력 섹션 표시
                    document.getElementById('verificationSection').classList.add('show');
                    // 이메일 입력 필드 비활성화
                    document.getElementById('email').readOnly = true;
                    document.getElementById('sendCodeBtn').textContent = '재발송';
                })
                .catch(error => {
                    loading.hide();
                    UI.error(error.message);
                });
        }

        function verifyCode() {
            var email = document.getElementById('email').value.trim();
            var code = document.getElementById('verificationCode').value.trim();

            if (code.length !== 6) {
                UI.warning('6자리 인증번호를 입력해주세요.');
                return;
            }

            var loading = UI.loading('인증번호 확인 중...');

            fetch('/api/auth/signup/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email, code: code })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '인증번호 확인에 실패했습니다.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    loading.hide();
                    UI.success(data.message);
                    // 인증 완료 처리
                    emailVerified = true;
                    verifiedEmail = email;
                    // UI 업데이트
                    document.getElementById('verificationSection').style.display = 'none';
                    document.getElementById('verifiedBadge').classList.add('show');
                    document.getElementById('sendCodeBtn').style.display = 'none';
                    checkSignupBtnEnabled();
                })
                .catch(error => {
                    loading.hide();
                    UI.error(error.message);
                });
        }

        function sendPhoneVerificationCode() {
            var phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (!phoneNumber) {
                UI.warning('휴대폰 번호를 입력해주세요.');
                return;
            }

            // 휴대폰 번호 형식 검증
            var phoneRegex = /^01[0-9]{8,9}$/;
            if (!phoneRegex.test(phoneNumber)) {
                UI.warning('올바른 휴대폰 번호 형식이 아닙니다. (예: 01012345678)');
                return;
            }

            var loading = UI.loading('인증번호 발송 중...');

            fetch('/api/sms/signup/send-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phoneNumber: phoneNumber })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '인증번호 발송에 실패했습니다.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    loading.hide();
                    UI.success(data.message);
                    // 인증번호 입력 섹션 표시
                    document.getElementById('phoneVerificationSection').classList.add('show');
                    // 휴대폰 번호 입력 필드 비활성화
                    document.getElementById('phoneNumber').readOnly = true;
                    document.getElementById('sendPhoneCodeBtn').textContent = '재발송';
                })
                .catch(error => {
                    loading.hide();
                    UI.error(error.message);
                });
        }

        function verifyPhoneCode() {
            var phoneNumber = document.getElementById('phoneNumber').value.trim();
            var code = document.getElementById('phoneVerificationCode').value.trim();

            if (code.length !== 6) {
                UI.warning('6자리 인증번호를 입력해주세요.');
                return;
            }

            var loading = UI.loading('인증번호 확인 중...');

            fetch('/api/sms/signup/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phoneNumber: phoneNumber, code: code })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '인증번호 확인에 실패했습니다.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    loading.hide();
                    UI.success(data.message);
                    // 인증 완료 처리
                    phoneVerified = true;
                    verifiedPhone = phoneNumber;
                    // UI 업데이트
                    document.getElementById('phoneVerificationSection').style.display = 'none';
                    document.getElementById('phoneVerifiedBadge').classList.add('show');
                    document.getElementById('sendPhoneCodeBtn').style.display = 'none';
                    checkSignupBtnEnabled();
                })
                .catch(error => {
                    loading.hide();
                    UI.error(error.message);
                });
        }

        function checkSignupBtnEnabled() {
            document.getElementById('signupBtn').disabled = !(emailVerified && phoneVerified);
        }

        function handleSignup(event) {
            event.preventDefault();

            // 이메일 인증 확인
            if (!emailVerified) {
                UI.warning('이메일 인증을 완료해주세요.');
                return;
            }

            // 휴대폰 인증 확인
            if (!phoneVerified) {
                UI.warning('휴대폰 인증을 완료해주세요.');
                return;
            }

            var username = document.getElementById('username').value.trim();
            var email = document.getElementById('email').value.trim();
            var phoneNumber = document.getElementById('phoneNumber').value.trim();
            var password = document.getElementById('password').value;
            var passwordConfirm = document.getElementById('passwordConfirm').value;

            // 인증된 이메일과 일치하는지 확인
            if (email !== verifiedEmail) {
                UI.warning('인증된 이메일과 일치하지 않습니다. 이메일 인증을 다시 진행해주세요.');
                emailVerified = false;
                document.getElementById('signupBtn').disabled = true;
                document.getElementById('verifiedBadge').classList.remove('show');
                document.getElementById('email').readOnly = false;
                document.getElementById('sendCodeBtn').style.display = 'inline-block';
                return;
            }

            // 인증된 휴대폰 번호와 일치하는지 확인
            if (phoneNumber !== verifiedPhone) {
                UI.warning('인증된 휴대폰 번호와 일치하지 않습니다. 휴대폰 인증을 다시 진행해주세요.');
                phoneVerified = false;
                document.getElementById('signupBtn').disabled = true;
                document.getElementById('phoneVerifiedBadge').classList.remove('show');
                document.getElementById('phoneNumber').readOnly = false;
                document.getElementById('sendPhoneCodeBtn').style.display = 'inline-block';
                return;
            }

            // 유효성 검사
            if (username.length < 4 || username.length > 20) {
                UI.warning('아이디는 4~20자여야 합니다.');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                UI.warning('아이디는 영문, 숫자, 언더스코어만 사용 가능합니다.');
                return;
            }

            if (password.length < 8 || password.length > 20) {
                UI.warning('비밀번호는 8~20자여야 합니다.');
                return;
            }

            if (password !== passwordConfirm) {
                UI.warning('비밀번호가 일치하지 않습니다.');
                return;
            }

            var loading = UI.loading('회원가입 중...');

            fetch('/api/auth/signup/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    email: email,
                    phoneNumber: phoneNumber,
                    password: password
                })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '회원가입 처리 중 오류가 발생했습니다.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    loading.hide();
                    UI.success(data.message);
                    // 로그인 페이지로 이동
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                })
                .catch(error => {
                    loading.hide();
                    UI.error(error.message);
                });
        }

        // 이메일 변경 시 인증 상태 초기화
        document.getElementById('email').addEventListener('input', function() {
            if (emailVerified && this.value.trim() !== verifiedEmail) {
                emailVerified = false;
                document.getElementById('signupBtn').disabled = true;
                document.getElementById('verifiedBadge').classList.remove('show');
            }
        });

        // 이메일 입력 필드에서 Enter 키 누르면 인증번호 발송
        document.getElementById('email').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!emailVerified) {
                    sendVerificationCode();
                }
            }
        });

        // 인증번호 입력 필드에서 Enter 키 누르면 인증 확인
        document.getElementById('verificationCode').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyCode();
            }
        });

        // 휴대폰 번호 변경 시 인증 상태 초기화
        document.getElementById('phoneNumber').addEventListener('input', function() {
            if (phoneVerified && this.value.trim() !== verifiedPhone) {
                phoneVerified = false;
                document.getElementById('signupBtn').disabled = true;
                document.getElementById('phoneVerifiedBadge').classList.remove('show');
            }
        });

        // 휴대폰 번호 입력 필드에서 Enter 키 누르면 인증번호 발송
        document.getElementById('phoneNumber').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!phoneVerified) {
                    sendPhoneVerificationCode();
                }
            }
        });

        // 휴대폰 인증번호 입력 필드에서 Enter 키 누르면 인증 확인
        document.getElementById('phoneVerificationCode').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyPhoneCode();
            }
        });
    </script>
</section>
</body>
</html>
