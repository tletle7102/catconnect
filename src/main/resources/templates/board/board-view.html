<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title layout:title>ê²Œì‹œê¸€ ìƒì„¸</title>
</head>
<section layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title" id="board-title"></h1>
            <div class="d-flex justify-content-between mb-3">
                <p class="mb-0" style="margin-left: 1rem;">ì‘ì„±ì: <span id="board-author"></span></p>
                <p class="mb-0" style="margin-right: 1rem;">ìƒì„± ì‹œê°„: <span id="board-created"></span></p>
            </div>
            <p class="card-text" id="board-content"></p>
            <button id="like-button" class="btn btn-outline-primary" onclick="toggleLike()"><span id="like-icon">ğŸ¤</span> <span id="like-count">0</span></button>
            <a th:href="@{/boards}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            <a th:href="@{/boards/{id}/comments/new(id=${boardId})}" class="btn btn-primary">ëŒ“ê¸€ ì¶”ê°€</a>
            <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì€ JavaScriptì—ì„œ ì‘ì„±ì ë³¸ì¸ì¼ ë•Œë§Œ í‘œì‹œ -->
            <span id="author-buttons" style="display: none;">
                <a th:href="@{/boards/{id}/edit(id=${boardId})}" class="btn btn-primary">ìˆ˜ì •</a>
                <button type="button" class="btn btn-danger" onclick="deleteBoard()">ì‚­ì œ</button>
            </span>
        </div>
    </div>
    <div id="comment-section">
        <h2 class="mt-3">ëŒ“ê¸€</h2>
        <ul class="list-group" id="comment-list"></ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:inline="javascript">
        console.log("board-view.html: ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘");
        // Thymeleafë¡œ ì „ë‹¬ëœ ê²Œì‹œê¸€ ID
        const boardId = [[${boardId}]]; // Thymeleaf ì¸ë¼ì¸ JavaScript
        console.log("board-view.html: boardId=" + boardId); // ë””ë²„ê¹… ë¡œê·¸
        let currentUsername = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
        let isLiked = false; // í˜„ì¬ ì‚¬ìš©ìì˜ ì¢‹ì•„ìš” ìƒíƒœ

        document.addEventListener('DOMContentLoaded', function () {
            console.log("board-view.html: DOM ë¡œë“œ ì™„ë£Œ, boardId=" + boardId);

            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            axios.get('/api/auth/check', { withCredentials: true })
                .then(response => {
                    if (response.data.data && response.data.data.authenticated) {
                        currentUsername = response.data.data.username;
                        console.log("board-view.html: ë¡œê·¸ì¸ ì‚¬ìš©ì=" + currentUsername);
                    }
                    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ í›„ ê²Œì‹œê¸€ ì¡°íšŒ
                    loadBoard();
                })
                .catch(error => {
                    console.error("board-view.html: ì¸ì¦ í™•ì¸ ì‹¤íŒ¨", error);
                    // ì¸ì¦ ì‹¤íŒ¨í•´ë„ ê²Œì‹œê¸€ì€ ì¡°íšŒ
                    loadBoard();
                });
        });

        function loadBoard() {
            console.log("board-view.html: ê²Œì‹œê¸€ ë¡œë“œ ì‹œì‘, boardId=" + boardId);
            // ê²Œì‹œê¸€ ID ìœ íš¨ì„± í™•ì¸
            if (!boardId || boardId === 0) {
                console.error("board-view.html: ìœ íš¨í•˜ì§€ ì•Šì€ boardId", boardId);
                UI.error("ì˜ëª»ëœ ê²Œì‹œê¸€ IDì…ë‹ˆë‹¤.");
                return;
            }
            // ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ API í˜¸ì¶œ
            axios.get('/api/boards/' + boardId, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ ì„±ê³µ", response.data);
                    const board = response.data.data;
                    console.log("board-view.html: board ë°ì´í„°", board); // ì¶”ê°€ ë””ë²„ê¹…
                    // ê²Œì‹œê¸€ ë°ì´í„° ìœ íš¨ì„± í™•ì¸
                    if (!board || !board.title) {
                        console.error("board-view.html: ìœ íš¨í•˜ì§€ ì•Šì€ board ë°ì´í„°", board);
                        UI.error("ê²Œì‹œê¸€ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }
                    // DOM ìš”ì†Œ í™•ì¸
                    const titleElement = document.getElementById('board-title');
                    const authorElement = document.getElementById('board-author');
                    const createdElement = document.getElementById('board-created');
                    const contentElement = document.getElementById('board-content');
                    const likeCountElement = document.getElementById('like-count');
                    if (!titleElement || !authorElement || !createdElement || !contentElement || !likeCountElement) {
                        console.error("board-view.html: DOM ìš”ì†Œ ëˆ„ë½", {
                            titleElement, authorElement, createdElement, contentElement, likeCountElement
                        });
                        UI.error("í˜ì´ì§€ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                    // ê²Œì‹œê¸€ ì •ë³´ ë Œë”ë§
                    titleElement.textContent = board.title;
                    authorElement.textContent = board.author;
                    createdElement.textContent = new Date(board.createdDttm).toLocaleString('ko-KR');
                    contentElement.textContent = board.content;
                    likeCountElement.textContent = board.likeCount;

                    // í˜„ì¬ ì‚¬ìš©ìì˜ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
                    if (currentUsername && board.likes) {
                        isLiked = board.likes.some(like => like.username === currentUsername);
                    }
                    updateLikeIcon();

                    // ì‘ì„±ì ë³¸ì¸ì¸ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                    if (currentUsername && currentUsername === board.author) {
                        const authorButtons = document.getElementById('author-buttons');
                        if (authorButtons) {
                            authorButtons.style.display = 'inline';
                        }
                    }

                    // ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
                    const commentList = document.getElementById('comment-list');
                    if (!commentList) {
                        console.error("board-view.html: comment-list ìš”ì†Œ ëˆ„ë½");
                        return;
                    }
                    commentList.innerHTML = ''; // ê¸°ì¡´ ëŒ“ê¸€ ì´ˆê¸°í™”
                    if (board.comments && board.comments.length > 0) {
                        board.comments.forEach(comment => {
                            renderComment(comment, commentList);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = 'ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
                        commentList.appendChild(li);
                    }
                })
                .catch(error => {
                    console.error("board-view.html: ê²Œì‹œê¸€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", error);
                    UI.handleApiError(error, "ê²Œì‹œê¸€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // ëŒ“ê¸€ ë Œë”ë§ í•¨ìˆ˜
        function renderComment(comment, commentList) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.id = 'comment-' + comment.id;

            const isAuthor = currentUsername && currentUsername === comment.author;

            const commentDiv = document.createElement('div');
            commentDiv.className = 'd-flex justify-content-between align-items-start';

            const contentDiv = document.createElement('div');
            contentDiv.id = 'comment-content-' + comment.id;
            contentDiv.innerHTML = `<strong>${comment.author}</strong>: ${comment.content} <small class="text-muted">(${new Date(comment.createdDttm).toLocaleString('ko-KR')})</small>`;

            commentDiv.appendChild(contentDiv);

            // ë³¸ì¸ ëŒ“ê¸€ì¸ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
            if (isAuthor) {
                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'btn-group btn-group-sm';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-outline-primary';
                editBtn.textContent = 'ìˆ˜ì •';
                editBtn.onclick = () => editComment(comment.id, comment.content);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger';
                deleteBtn.textContent = 'ì‚­ì œ';
                deleteBtn.onclick = () => deleteMyComment(comment.id);

                buttonGroup.appendChild(editBtn);
                buttonGroup.appendChild(deleteBtn);
                commentDiv.appendChild(buttonGroup);
            }

            li.appendChild(commentDiv);
            commentList.appendChild(li);
        }

        // ëŒ“ê¸€ ìˆ˜ì •
        async function editComment(commentId, currentContent) {
            const newContent = await UI.prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:', 'ëŒ“ê¸€ ìˆ˜ì •', {
                defaultValue: currentContent,
                inputType: 'textarea',
                required: true
            });
            if (newContent === null) {
                return;
            }

            console.log("board-view.html: ëŒ“ê¸€ ìˆ˜ì • ìš”ì²­, commentId=" + commentId);
            axios.put('/api/comments/' + commentId, { content: newContent }, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: ëŒ“ê¸€ ìˆ˜ì • ì„±ê³µ", response.data);
                    UI.success("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadBoard();
                })
                .catch(error => {
                    console.error("board-view.html: ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨", error);
                    UI.handleApiError(error, "ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // ë‚´ ëŒ“ê¸€ ì‚­ì œ
        async function deleteMyComment(commentId) {
            const confirmed = await UI.confirmDelete('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (!confirmed) {
                return;
            }

            console.log("board-view.html: ëŒ“ê¸€ ì‚­ì œ ìš”ì²­, commentId=" + commentId);
            axios.delete('/api/comments/my/' + commentId, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ", response.data);
                    UI.success("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadBoard();
                })
                .catch(error => {
                    console.error("board-view.html: ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨", error);
                    UI.handleApiError(error, "ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // ì¢‹ì•„ìš” ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        function updateLikeIcon() {
            const likeIcon = document.getElementById('like-icon');
            if (likeIcon) {
                likeIcon.textContent = isLiked ? 'â¤ï¸' : 'ğŸ¤';
            }
        }

        // ì¢‹ì•„ìš” í† ê¸€ ì²˜ë¦¬
        function toggleLike() {
            console.log("board-view.html: ì¢‹ì•„ìš” í† ê¸€ ìš”ì²­, boardId=" + boardId);
            // ì¢‹ì•„ìš” í† ê¸€ API í˜¸ì¶œ
            axios.post('/api/likes/' + boardId, {}, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: ì¢‹ì•„ìš” í† ê¸€ ì„±ê³µ", response.data);
                    // ì‘ë‹µì—ì„œ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ (true: ì¶”ê°€ë¨, false: ì‚­ì œë¨)
                    isLiked = response.data.data;
                    updateLikeIcon();
                    // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                    const likeCountElement = document.getElementById('like-count');
                    let currentCount = parseInt(likeCountElement.textContent) || 0;
                    likeCountElement.textContent = isLiked ? currentCount + 1 : currentCount - 1;
                })
                .catch(error => {
                    console.error("board-view.html: ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨", error);
                    UI.handleApiError(error, "ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deleteBoard() {
            const confirmed = await UI.confirmDelete('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëŒ“ê¸€ê³¼ ì¢‹ì•„ìš”ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.');
            if (!confirmed) {
                return;
            }

            console.log("board-view.html: ê²Œì‹œê¸€ ì‚­ì œ ìš”ì²­, boardId=" + boardId);
            axios.delete('/api/boards/' + boardId, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: ê²Œì‹œê¸€ ì‚­ì œ ì„±ê³µ", response.data);
                    UI.success("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setTimeout(() => {
                        window.location.href = '/boards';
                    }, 1000);
                })
                .catch(error => {
                    console.error("board-view.html: ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨", error);
                    UI.handleApiError(error, "ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }
    </script>
</section>
</html>