<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title layout:title>게시글 상세</title>
</head>
<section layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title" id="board-title"></h1>
            <div class="d-flex justify-content-between mb-3">
                <p class="mb-0" style="margin-left: 1rem;">작성자: <span id="board-author"></span></p>
                <p class="mb-0" style="margin-right: 1rem;">생성 시간: <span id="board-created"></span></p>
            </div>
            <p class="card-text" id="board-content"></p>
            <button id="like-button" class="btn btn-outline-primary" onclick="addLike()">좋아요 <span id="like-count">0</span></button>
            <a th:href="@{/boards}" class="btn btn-secondary">목록으로 돌아가기</a>
            <a th:href="@{/boards/{id}/comments/new(id=${boardId})}" class="btn btn-primary">댓글 추가</a>
            <a th:href="@{/boards/{id}/edit(id=${boardId})}" class="btn btn-primary" sec:authorize="isAuthenticated()">수정</a>
        </div>
    </div>
    <div id="comment-section">
        <h2 class="mt-3">댓글</h2>
        <ul class="list-group" id="comment-list"></ul>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:inline="javascript">
        console.log("board-view.html: 스크립트 로드 시작");
        // Thymeleaf로 전달된 게시글 ID
        const boardId = [[${boardId}]]; // Thymeleaf 인라인 JavaScript
        console.log("board-view.html: boardId=" + boardId); // 디버깅 로그
        let currentUsername = null; // 현재 로그인한 사용자

        document.addEventListener('DOMContentLoaded', function () {
            console.log("board-view.html: DOM 로드 완료, boardId=" + boardId);

            // 현재 로그인한 사용자 정보 가져오기
            axios.get('/auth/check', { withCredentials: true })
                .then(response => {
                    if (response.data.authenticated) {
                        currentUsername = response.data.username;
                        console.log("board-view.html: 로그인 사용자=" + currentUsername);
                    }
                    // 사용자 정보 로드 후 게시글 조회
                    loadBoard();
                })
                .catch(error => {
                    console.error("board-view.html: 인증 확인 실패", error);
                    // 인증 실패해도 게시글은 조회
                    loadBoard();
                });
        });

        function loadBoard() {
            console.log("board-view.html: 게시글 로드 시작, boardId=" + boardId);
            // 게시글 ID 유효성 확인
            if (!boardId || boardId === 0) {
                console.error("board-view.html: 유효하지 않은 boardId", boardId);
                alert("잘못된 게시글 ID입니다.");
                return;
            }
            // 게시글 상세 조회 API 호출
            axios.get('/api/boards/' + boardId, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: 게시글 데이터 로드 성공", response.data);
                    const board = response.data.data;
                    console.log("board-view.html: board 데이터", board); // 추가 디버깅
                    // 게시글 데이터 유효성 확인
                    if (!board || !board.title) {
                        console.error("board-view.html: 유효하지 않은 board 데이터", board);
                        alert("게시글 데이터가 올바르지 않습니다.");
                        return;
                    }
                    // DOM 요소 확인
                    const titleElement = document.getElementById('board-title');
                    const authorElement = document.getElementById('board-author');
                    const createdElement = document.getElementById('board-created');
                    const contentElement = document.getElementById('board-content');
                    const likeCountElement = document.getElementById('like-count');
                    if (!titleElement || !authorElement || !createdElement || !contentElement || !likeCountElement) {
                        console.error("board-view.html: DOM 요소 누락", {
                            titleElement, authorElement, createdElement, contentElement, likeCountElement
                        });
                        alert("페이지 렌더링 중 오류가 발생했습니다.");
                        return;
                    }
                    // 게시글 정보 렌더링
                    titleElement.textContent = board.title;
                    authorElement.textContent = board.author;
                    createdElement.textContent = new Date(board.createdDttm).toLocaleString('ko-KR');
                    contentElement.textContent = board.content;
                    likeCountElement.textContent = board.likeCount;

                    // 댓글 목록 렌더링
                    const commentList = document.getElementById('comment-list');
                    if (!commentList) {
                        console.error("board-view.html: comment-list 요소 누락");
                        return;
                    }
                    commentList.innerHTML = ''; // 기존 댓글 초기화
                    if (board.comments && board.comments.length > 0) {
                        board.comments.forEach(comment => {
                            renderComment(comment, commentList);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = '댓글이 없습니다.';
                        commentList.appendChild(li);
                    }
                })
                .catch(error => {
                    console.error("board-view.html: 게시글 데이터 로드 실패", error);
                    alert(error.response?.data?.message || "게시글 로드 중 오류가 발생했습니다.");
                });
        }

        // 댓글 렌더링 함수
        function renderComment(comment, commentList) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.id = 'comment-' + comment.id;

            const isAuthor = currentUsername && currentUsername === comment.author;

            const commentDiv = document.createElement('div');
            commentDiv.className = 'd-flex justify-content-between align-items-start';

            const contentDiv = document.createElement('div');
            contentDiv.id = 'comment-content-' + comment.id;
            contentDiv.innerHTML = `<strong>${comment.author}</strong>: ${comment.content} <small class="text-muted">(${new Date(comment.createdDttm).toLocaleString('ko-KR')})</small>`;

            commentDiv.appendChild(contentDiv);

            // 본인 댓글인 경우 수정/삭제 버튼 추가
            if (isAuthor) {
                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'btn-group btn-group-sm';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-outline-primary';
                editBtn.textContent = '수정';
                editBtn.onclick = () => editComment(comment.id, comment.content);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-outline-danger';
                deleteBtn.textContent = '삭제';
                deleteBtn.onclick = () => deleteMyComment(comment.id);

                buttonGroup.appendChild(editBtn);
                buttonGroup.appendChild(deleteBtn);
                commentDiv.appendChild(buttonGroup);
            }

            li.appendChild(commentDiv);
            commentList.appendChild(li);
        }

        // 댓글 수정
        function editComment(commentId, currentContent) {
            const newContent = prompt('댓글을 수정하세요:', currentContent);
            if (newContent === null || newContent.trim() === '') {
                return;
            }

            console.log("board-view.html: 댓글 수정 요청, commentId=" + commentId);
            axios.put('/api/comments/' + commentId, { content: newContent }, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: 댓글 수정 성공", response.data);
                    // 성공 시 페이지 새로고침
                    loadBoard();
                })
                .catch(error => {
                    console.error("board-view.html: 댓글 수정 실패", error);
                    alert(error.response?.data?.message || "댓글 수정 중 오류가 발생했습니다.");
                });
        }

        // 내 댓글 삭제
        function deleteMyComment(commentId) {
            if (!confirm('댓글을 삭제하시겠습니까?')) {
                return;
            }

            console.log("board-view.html: 댓글 삭제 요청, commentId=" + commentId);
            axios.delete('/api/comments/my/' + commentId, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: 댓글 삭제 성공", response.data);
                    // 성공 시 페이지 새로고침
                    loadBoard();
                })
                .catch(error => {
                    console.error("board-view.html: 댓글 삭제 실패", error);
                    alert(error.response?.data?.message || "댓글 삭제 중 오류가 발생했습니다.");
                });
        }

        // 좋아요 추가 처리
        function addLike() {
            console.log("board-view.html: 좋아요 추가 요청, boardId=" + boardId);
            // 좋아요 추가 API 호출
            axios.post('/api/likes/' + boardId, {}, { withCredentials: true })
                .then(response => {
                    console.log("board-view.html: 좋아요 추가 성공", response.data);
                    // 성공 시 페이지 새로고침
                    window.location.reload();
                })
                .catch(error => {
                    console.error("board-view.html: 좋아요 추가 실패", error);
                    alert(error.response?.data?.message || "좋아요 추가 중 오류가 발생했습니다.");
                });
        }
    </script>
</section>
</html>