<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>검색 결과</title>
</head>
<section layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title">검색 결과</h1>
            <p class="text-muted">키워드: "<span id="keyword-display"></span>", 검색 타입: <span id="type-display"></span></p>

            <!-- 통합 검색 결과 테이블 -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>타입</th>
                        <th>ID</th>
                        <th>내용</th>
                        <th>작성자</th>
                        <th>생성 시간</th>
                    </tr>
                    </thead>
                    <tbody id="result-list"></tbody>
                </table>
            </div>
            <!-- 페이지네이션 -->
            <nav aria-label="검색 결과 페이지 네비게이션">
                <ul class="pagination justify-content-center" id="search-pagination"></ul>
            </nav>

            <a th:href="@{/boards}" class="btn btn-secondary mt-3">게시판으로 돌아가기</a>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:inline="javascript">
        console.log("search-results.html: 스크립트 로드 시작");
        // Thymeleaf로 전달된 검색 파라미터
        const keyword = [[${keyword}]];
        const type = [[${type}]];
        console.log("search-results.html: keyword=" + keyword + ", type=" + type);

        // 전체 검색 결과를 저장할 배열
        let allResults = [];
        // 페이지네이션 상태
        let currentPage = 0;
        const pageSize = 10;

        document.addEventListener('DOMContentLoaded', function () {
            console.log("search-results.html: DOM 로드 완료");

            // 검색 파라미터 표시
            document.getElementById('keyword-display').textContent = keyword || '';
            document.getElementById('type-display').textContent = type || 'ALL';

            // 검색 실행
            if (keyword && keyword.trim() !== '') {
                searchData(keyword, type);
            } else {
                console.warn("search-results.html: 검색 키워드 없음");
                alert("검색 키워드를 입력하세요.");
            }
        });

        function searchData(keyword, type) {
            console.log("search-results.html: 검색 API 호출 시작, keyword=" + keyword + ", type=" + type);
            // 서버에서 충분한 수의 결과를 가져오기 위해 큰 page size 사용
            axios.get('/api/search', {
                params: { keyword: keyword, type: type, page: 0, size: 1000 },
                withCredentials: true
            })
                .then(response => {
                    console.log("search-results.html: 검색 API 호출 성공", response.data);
                    const result = response.data.data;

                    // 게시글과 댓글 결과를 통합
                    allResults = [];

                    // 게시글 결과 추가
                    if (result.boardPage && result.boardPage.content) {
                        result.boardPage.content.forEach(board => {
                            allResults.push({
                                type: '게시글',
                                id: board.id,
                                content: board.title,
                                author: board.author,
                                createdDttm: board.createdDttm,
                                link: `/boards/${board.id}`
                            });
                        });
                    }

                    // 댓글 결과 추가
                    if (result.commentPage && result.commentPage.content) {
                        result.commentPage.content.forEach(comment => {
                            allResults.push({
                                type: '댓글',
                                id: comment.id,
                                content: comment.content,
                                author: comment.author,
                                createdDttm: comment.createdDttm,
                                link: `/boards/${comment.boardId}`
                            });
                        });
                    }

                    // 생성 시간 기준 내림차순 정렬
                    allResults.sort((a, b) => new Date(b.createdDttm) - new Date(a.createdDttm));

                    // 첫 페이지 렌더링
                    currentPage = 0;
                    renderResults();
                })
                .catch(error => {
                    console.error("search-results.html: 검색 API 호출 실패", error);
                    alert(error.response?.data?.message || "검색 중 오류가 발생했습니다.");
                });
        }

        function renderResults() {
            const tbody = document.getElementById('result-list');
            tbody.innerHTML = '';

            // 현재 페이지에 해당하는 결과만 추출
            const startIdx = currentPage * pageSize;
            const endIdx = Math.min(startIdx + pageSize, allResults.length);
            const pageResults = allResults.slice(startIdx, endIdx);

            if (pageResults.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" class="text-center">검색 결과가 없습니다.</td>';
                tbody.appendChild(tr);
            } else {
                pageResults.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="badge ${item.type === '게시글' ? 'bg-primary' : 'bg-success'}">${item.type}</span></td>
                        <td>${item.id}</td>
                        <td><a href="${item.link}">${item.content}</a></td>
                        <td>${item.author}</td>
                        <td>${new Date(item.createdDttm).toLocaleString('ko-KR')}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById('search-pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(allResults.length / pageSize);

            if (totalPages <= 1) return;

            // 이전 버튼
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item' + (currentPage === 0 ? ' disabled' : '');
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">이전</a>`;
            pagination.appendChild(prevLi);

            // 페이지 번호 (최대 5개 표시)
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, startPage + 4);
            if (endPage - startPage < 4) {
                startPage = Math.max(0, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i + 1}</a>`;
                pagination.appendChild(li);
            }

            // 다음 버튼
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item' + (currentPage >= totalPages - 1 ? ' disabled' : '');
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">다음</a>`;
            pagination.appendChild(nextLi);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(allResults.length / pageSize);
            if (page < 0 || page >= totalPages) return;
            currentPage = page;
            renderResults();
        }
    </script>
</section>
</html>
